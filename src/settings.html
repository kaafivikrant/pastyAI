<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QuickLLM Settings</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      margin: 0 0 24px 0;
      color: #007AFF;
      text-align: center;
    }

    .section {
      margin-bottom: 24px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .section h3 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }

    select, input[type="text"], textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .btn {
      padding: 10px 20px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
    }

    .btn:hover {
      background: #f0f0f0;
    }

    .btn.primary {
      background: #007AFF;
      color: white;
      border-color: #007AFF;
    }

    .btn.primary:hover {
      background: #0056b3;
    }

    .controls {
      text-align: center;
      margin-top: 24px;
    }

    .status {
      padding: 12px;
      margin: 12px 0;
      border-radius: 6px;
      text-align: center;
    }

    .status.success {
      background: #D4EDDA;
      color: #155724;
      border: 1px solid #C3E6CB;
    }

    .status.error {
      background: #F8D7DA;
      color: #721C24;
      border: 1px solid #F5C6CB;
    }

    .hidden {
      display: none;
    }

    .model-info {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âš¡ QuickLLM Settings</h1>

    <div id="status" class="status hidden">
      <span id="status-text"></span>
    </div>

    <div class="section">
      <h3>Model Configuration</h3>
      
      <div class="form-group">
        <label for="provider">Provider:</label>
        <select id="provider" onchange="updateProviderSettings()">
          <option value="ollama">Ollama (Local)</option>
          <option value="groq">Groq (Cloud)</option>
          <option value="openrouter">OpenRouter (Cloud)</option>
        </select>
        <div class="model-info">Local models provide privacy, cloud models may be faster</div>
      </div>

      <div class="form-group" id="ollama-model-group">
        <label for="ollama-model">Ollama Model:</label>
        <select id="ollama-model">
          <option value="qwen3:4b">Llama 3.2 3B</option>
          <option value="llama3.2:1b">Llama 3.2 1B</option>
          <option value="llama3.1:8b">Llama 3.1 8B</option>
          <option value="qwen2.5:3b">Qwen 2.5 3B</option>
        </select>
        <div class="model-info">Make sure the model is pulled: <code>ollama pull qwen3:4b</code></div>
      </div>

      <div class="form-group hidden" id="groq-settings">
        <label for="groq-api-key">Groq API Key:</label>
        <input type="password" id="groq-api-key" placeholder="Enter your Groq API key">
        <div class="model-info">Get your API key from <a href="https://console.groq.com/" target="_blank">console.groq.com</a></div>
        
        <label for="groq-model">Groq Model:</label>
        <select id="groq-model">
          <option value="llama3-8b-8192">Llama 3 8B</option>
          <option value="llama3-70b-8192">Llama 3 70B</option>
          <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
          <option value="gemma-7b-it">Gemma 7B IT</option>
        </select>
        <button class="btn" onclick="fetchModels('groq')" style="margin-top: 8px;">Fetch Available Models</button>
      </div>

      <div class="form-group hidden" id="openrouter-settings">
        <label for="openrouter-api-key">OpenRouter API Key:</label>
        <input type="password" id="openrouter-api-key" placeholder="Enter your OpenRouter API key">
        <div class="model-info">Get your API key from <a href="https://openrouter.ai/" target="_blank">openrouter.ai</a></div>
        
        <label for="openrouter-model">OpenRouter Model:</label>
        <select id="openrouter-model">
          <option value="meta-llama/llama-3-8b-instruct">Llama 3 8B Instruct</option>
          <option value="meta-llama/llama-3-70b-instruct">Llama 3 70B Instruct</option>
          <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
          <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
        </select>
        <button class="btn" onclick="fetchModels('openrouter')" style="margin-top: 8px;">Fetch Available Models</button>
      </div>
    </div>

    <div class="section">
      <h3>Current Mode Prompt</h3>
      
      <div class="form-group">
        <label for="current-mode">Mode:</label>
        <select id="current-mode" onchange="loadModePrompt()">
          <option value="auto">Auto (Smart Detection)</option>
          <option value="summarize">Summarize</option>
          <option value="translate">Translate</option>
          <option value="simplify">Simplify</option>
          <option value="explain">Explain</option>
        </select>
      </div>

      <div class="form-group">
        <label for="system-prompt">System Prompt:</label>
        <textarea id="system-prompt" placeholder="Enter the system prompt for this mode..."></textarea>
      </div>
    </div>

    <div class="controls">
      <button class="btn" onclick="testConnection()">Test Connection</button>
      <button class="btn" onclick="loadSettings()">Reload</button>
      <button class="btn primary" onclick="saveSettings()">Save Settings</button>
      <button class="btn" onclick="window.close()">Close</button>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const Store = require('electron-store');
    const store = new Store();

    let currentSettings = {};

    // Load settings on startup
    window.addEventListener('DOMContentLoaded', () => {
      loadSettings();
    });

    function loadSettings() {
      try {
        // Load model config
        const modelConfig = store.get('model', {});
        
        document.getElementById('provider').value = modelConfig.provider || 'ollama';
        document.getElementById('ollama-model').value = modelConfig.ollamaModel || 'qwen3:4b';
        document.getElementById('groq-model').value = modelConfig.groqModel || 'llama3-8b-8192';
        document.getElementById('openrouter-model').value = modelConfig.openrouterModel || 'meta-llama/llama-3-8b-instruct';
        
        // For API keys, show placeholder text if they exist but don't reveal actual keys
        const groqKey = modelConfig.groqApiKey;
        const openrouterKey = modelConfig.openrouterApiKey;
        
        if (groqKey && groqKey.trim() !== '') {
          document.getElementById('groq-api-key').placeholder = 'API key configured (gsk_***)';
        } else {
          document.getElementById('groq-api-key').placeholder = 'Enter your Groq API key';
        }
        
        if (openrouterKey && openrouterKey.trim() !== '') {
          document.getElementById('openrouter-api-key').placeholder = 'API key configured (sk-or-***)';
        } else {
          document.getElementById('openrouter-api-key').placeholder = 'Enter your OpenRouter API key';
        }
        
        // Clear the input fields for security
        document.getElementById('groq-api-key').value = '';
        document.getElementById('openrouter-api-key').value = '';

        // Load current mode
        const currentMode = store.get('currentMode', 'summarize');
        document.getElementById('current-mode').value = currentMode;

        updateProviderSettings();
        loadModePrompt();

        showStatus('Settings loaded successfully', 'success');
      } catch (error) {
        showStatus('Error loading settings: ' + error.message, 'error');
      }
    }

    function updateProviderSettings() {
      const provider = document.getElementById('provider').value;
      
      // Hide all provider-specific settings
      document.getElementById('ollama-model-group').style.display = provider === 'ollama' ? 'block' : 'none';
      document.getElementById('groq-settings').style.display = provider === 'groq' ? 'block' : 'none';
      document.getElementById('openrouter-settings').style.display = provider === 'openrouter' ? 'block' : 'none';
    }

    function loadModePrompt() {
      const mode = document.getElementById('current-mode').value;
      const modes = store.get('modes', {});
      
      if (modes[mode]) {
        document.getElementById('system-prompt').value = modes[mode].systemPrompt;
      }
    }

    function saveSettings() {
      try {
        const provider = document.getElementById('provider').value;
        
        // Save basic model config (without API keys)
        const modelConfig = {
          provider: provider,
          ollamaModel: document.getElementById('ollama-model').value,
          groqModel: document.getElementById('groq-model').value,
          openrouterModel: document.getElementById('openrouter-model').value
        };
        
        store.set('model', { ...store.get('model', {}), ...modelConfig });

        // Securely store API keys if provided
        const groqKey = document.getElementById('groq-api-key').value;
        const openrouterKey = document.getElementById('openrouter-api-key').value;
        
        let keysSaved = 0;
        let totalKeys = 0;
        
        if (groqKey && groqKey.trim() !== '') {
          totalKeys++;
          ipcRenderer.send('store-api-key', { provider: 'groq', apiKey: groqKey.trim() });
        }
        
        if (openrouterKey && openrouterKey.trim() !== '') {
          totalKeys++;
          ipcRenderer.send('store-api-key', { provider: 'openrouter', apiKey: openrouterKey.trim() });
        }

        // Save current mode prompt
        const mode = document.getElementById('current-mode').value;
        const systemPrompt = document.getElementById('system-prompt').value;
        
        const modes = store.get('modes', {});
        if (modes[mode]) {
          modes[mode].systemPrompt = systemPrompt;
          store.set('modes', modes);
        }

        // Set current mode
        store.set('currentMode', mode);

        if (totalKeys === 0) {
          showStatus('Settings saved successfully!', 'success');
        } else {
          showStatus('Settings saved, securing API keys...', 'processing');
        }
      } catch (error) {
        showStatus('Error saving settings: ' + error.message, 'error');
      }
    }

    function testConnection() {
      showStatus('Testing connection...', 'processing');
      
      // Save current settings first
      saveSettings();
      
      // Send test request to main process
      ipcRenderer.send('test-connection');
    }

    function fetchModels(provider) {
      showStatus(`Fetching ${provider} models...`, 'processing');
      
      // Save current settings first to ensure API keys are available
      saveSettings();
      
      // Send fetch request to main process
      ipcRenderer.send('fetch-models', provider);
    }

    // Listen for models response
    ipcRenderer.on('models-fetched', (event, data) => {
      const { provider, models, error } = data;
      
      if (error) {
        showStatus(`Error fetching ${provider} models: ${error}`, 'error');
        return;
      }
      
      if (models.length === 0) {
        showStatus(`No models found for ${provider}`, 'error');
        return;
      }
      
      // Update the appropriate dropdown
      let selectElement;
      if (provider === 'groq') {
        selectElement = document.getElementById('groq-model');
      } else if (provider === 'openrouter') {
        selectElement = document.getElementById('openrouter-model');
      }
      
      if (selectElement) {
        // Clear existing options
        selectElement.innerHTML = '';
        
        // Add new options
        models.forEach(model => {
          const option = document.createElement('option');
          option.value = model.id || model.name;
          option.textContent = model.id || model.name;
          selectElement.appendChild(option);
        });
        
        showStatus(`Successfully loaded ${models.length} ${provider} models`, 'success');
      }
    });

    // Listen for status updates from main process
    ipcRenderer.on('status-update', (event, message, type) => {
      showStatus(message, type);
    });

    // Listen for API key storage responses
    ipcRenderer.on('api-key-stored', (event, result) => {
      if (result.success) {
        showStatus(result.message, 'success');
        // Clear the input field after successful storage
        if (result.message.includes('Groq')) {
          document.getElementById('groq-api-key').value = '';
          document.getElementById('groq-api-key').placeholder = 'API key configured (gsk_***)';
        } else if (result.message.includes('OpenRouter')) {
          document.getElementById('openrouter-api-key').value = '';
          document.getElementById('openrouter-api-key').placeholder = 'API key configured (sk-or-***)';
        }
      } else {
        showStatus(result.message, 'error');
      }
    });

    // Listen for API key validation responses
    ipcRenderer.on('api-key-validated', (event, result) => {
      const status = result.valid ? 'success' : 'error';
      showStatus(`${result.provider} API key: ${result.message}`, status);
    });

    // Listen for masked API key responses
    ipcRenderer.on('masked-api-key', (event, result) => {
      if (result.masked) {
        console.log(`${result.provider} API key: ${result.masked}`);
      }
    });

    function showStatus(message, type) {
      const status = document.getElementById('status');
      const statusText = document.getElementById('status-text');
      
      statusText.textContent = message;
      status.className = `status ${type}`;
      status.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          status.classList.add('hidden');
        }, 3000);
      }
    }
  </script>
</body>
</html>
